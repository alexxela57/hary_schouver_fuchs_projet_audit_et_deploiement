networks:
  monitoring: {}

services:
  agent_a:
    build: ./agent
    container_name: agent_a
    environment: { INTERVAL: "10" }
    command: >
      sh -c "busybox httpd -f -p 9101 -h /app &
             while true; do ruby /app/script_final.rb; sleep ${INTERVAL:-10}; done"
    healthcheck:
      test: ["CMD", "busybox", "wget", "-qO-", "http://localhost:9101/audit.json"]
      interval: 10s
      timeout: 3s
      retries: 10
    ports: ["9101:9101"]
    networks: [monitoring]
    restart: unless-stopped

  agent_b:
    build: ./agent
    container_name: agent_b
    environment: { INTERVAL: "10" }
    command: >
      sh -c "busybox httpd -f -p 9102 -h /app &
             while true; do ruby /app/script_final.rb; sleep ${INTERVAL:-10}; done"
    healthcheck:
      test: ["CMD", "busybox", "wget", "-qO-", "http://localhost:9102/audit.json"]
      interval: 10s
      timeout: 3s
      retries: 10
    ports: ["9102:9102"]
    networks: [monitoring]
    restart: unless-stopped

  json_exporter:
    image: quay.io/prometheuscommunity/json-exporter:v0.7.0
    command: ["--config.file=/config.yml","--log.level=debug"]
    volumes: [ "./json_exporter/config.yml:/config.yml:ro" ]
    ports: ["7979:7979"]
    depends_on: [agent_a, agent_b]
    networks: [monitoring]
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    volumes: [ "./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro" ]
    ports: ["9090:9090"]
    depends_on: [json_exporter]
    networks: [monitoring]
    restart: unless-stopped

  grafana:
    image: grafana/grafana-oss:latest
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    volumes: [ "./grafana/provisioning:/etc/grafana/provisioning:ro" ]
    ports: ["3000:3000"]
    depends_on: [prometheus]
    networks: [monitoring]
    restart: unless-stopped
